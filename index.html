<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Карта Городка</title>
  <style>
    /* Добавьте в стили в head */
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
}

canvas {
    display: block;
    width: 100vw;
    height: 100vh;
    object-fit: contain;
}

/* Для мобильных устройств */
@media (max-width: 768px) {
    canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
}

:root {
    --ui-bg: rgba(255, 255, 255, 0.9);
    --ui-text: #000;
    --ui-hover: #f0f0f0;
}

[data-theme="dark"] {
    --ui-bg: rgba(30, 30, 30, 0.9);
    --ui-text: #fff;
    --ui-hover: #444;
}

body { 
    margin: 0; 
    overflow: hidden; 
    background: #000; 
    font-family: sans-serif; 
}

#ui-layer {
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    z-index: 1000; 
    pointer-events: none;
}

.search-container {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: min(90%, 500px);
    pointer-events: auto;
    z-index: 1001;
}

#search-input {
    width: 100%;
    box-sizing: border-box;
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    background: var(--ui-bg);
    color: var(--ui-text);
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    font-size: 16px;
    outline: none;
    pointer-events: auto;
}

#search-results {
    width: 100%;
    box-sizing: border-box;
    background: var(--ui-bg);
    border-radius: 10px;
    margin-top: 5px;
    display: none;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    pointer-events: auto;
    z-index: 1002;
    position: absolute;
}

#search-results::-webkit-scrollbar {
    display: none;
}

#search-results {
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.result-item {
    padding: 12px 15px;
    color: var(--ui-text);
    cursor: pointer;
    border-bottom: 1px solid rgba(128,128,128,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    line-height: 1.4;
    pointer-events: auto;
}

.result-item:hover {
    background: var(--ui-hover);
}

.result-name {
    flex: 1;
    word-break: break-word;
}

.result-type {
    opacity: 0.5;
    font-size: 11px;
    text-transform: uppercase;
    white-space: nowrap;
    background: rgba(128,128,128,0.1);
    padding: 2px 6px;
    border-radius: 4px;
}

.highlight {
    color: #ff4757;
    font-weight: bold;
}

#search-input::-webkit-calendar-picker-indicator {
    display: none !important;
}

.controls {
    position: absolute; 
    right: 20px; 
    top: 50%; 
    transform: translateY(-50%);
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    pointer-events: auto;
    z-index: 1001;
}

.btn {
    width: 50px; 
    height: 50px; 
    border-radius: 50%; 
    border: none;
    background: var(--ui-bg); 
    color: var(--ui-text);
    cursor: pointer; 
    font-size: 20px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    pointer-events: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

.btn:hover {
    transform: scale(1.05);
}

.btn:active {
    transform: scale(0.95);
}

/* Для предотвращения выделения текста при кликах */
canvas {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

    /* Добавьте в тег style в index.html */
.admin-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.admin-modal-content {
    background: var(--ui-bg);
    color: var(--ui-text);
    padding: 20px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.admin-form-section {
    margin-bottom: 15px;
}

.admin-form-section label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.admin-form-section input,
.admin-form-section select,
.admin-form-section textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}

.coord-input {
    display: flex;
    gap: 5px;
}

.coord-input input {
    flex: 1;
}

.admin-modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.admin-modal-buttons button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.admin-modal-buttons button:first-child {
    background: #4CAF50;
    color: white;
}

.admin-modal-buttons button:last-child {
    background: #f44336;
    color: white;
}

.admin-btn, .admin-add-btn {
    margin-top: 10px;
}

/* ============= НАЧАЛО: ОБНОВЛЕННЫЕ МОБИЛЬНЫЕ СТИЛИ (ЗАМЕНИТЕ СТАРЫЕ) ============= */

/* Обновленные стили для мобильных устройств */
@media (max-width: 768px) {
  /* Исправление выпадающего списка */
  #search-results {
    position: fixed !important;
    top: 70px !important;
    left: 10px !important;
    right: 10px !important;
    width: calc(100% - 20px) !important;
    max-width: calc(100% - 20px) !important;
    max-height: 60vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 1002;
    box-sizing: border-box;
    margin: 0 !important;
  }
  
  .result-item {
    min-height: 44px;
    padding: 12px 16px;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-sizing: border-box;
    border-bottom: 1px solid rgba(128,128,128,0.1);
    width: 100%;
    overflow: hidden;
  }
  
  .result-name {
    flex: 1;
    word-break: break-word;
    overflow-wrap: break-word;
    max-width: 70%;
  }
  
  .result-type {
    font-size: 11px;
    opacity: 0.6;
    text-transform: uppercase;
    white-space: nowrap;
    margin-left: 8px;
    background: rgba(128,128,128,0.1);
    padding: 2px 6px;
    border-radius: 4px;
  }
  
  /* Улучшение кнопок для мобильных */
  .controls {
    position: fixed !important;
    bottom: max(20px, env(safe-area-inset-bottom)) !important;
    right: 50% !important;
    transform: translateX(50%) !important;
    flex-direction: row !important;
    gap: 20px !important;
    top: auto !important;
    z-index: 1001 !important;
    background: none !important;
    left: auto !important;
  }
  
  .btn {
    width: 60px !important;
    height: 60px !important;
    font-size: 24px !important;
    border-radius: 50% !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3) !important;
    position: relative !important;
    z-index: 1002 !important;
    touch-action: manipulation !important;
    -webkit-tap-highlight-color: rgba(0,0,0,0.1) !important;
  }
  
  /* Увеличиваем зону клика */
  .btn::after {
    content: '';
    position: absolute;
    top: -15px;
    left: -15px;
    right: -15px;
    bottom: -15px;
  }
  
  /* Поле поиска */
  #search-input {
    padding: 16px 20px !important;
    font-size: 18px !important;
    border-radius: 12px !important;
    height: auto !important;
    min-height: 56px !important;
    -webkit-appearance: none !important;
    appearance: none !important;
  }
  
  .search-container {
    position: fixed !important;
    top: max(10px, env(safe-area-inset-top)) !important;
    left: 10px !important;
    right: 10px !important;
    width: calc(100% - 20px) !important;
    transform: none !important;
    z-index: 1003 !important;
    margin: 0 !important;
  }
}

/* Очень маленькие экраны */
@media (max-width: 480px) {
  .btn {
    width: 56px !important;
    height: 56px !important;
    font-size: 22px !important;
  }
  
  .controls {
    gap: 15px !important;
    bottom: max(15px, env(safe-area-inset-bottom)) !important;
  }
  
  #search-input {
    padding: 14px 18px !important;
    font-size: 16px !important;
    min-height: 52px !important;
  }
  
  #search-results {
    top: 65px !important;
  }
}

/* Предотвращение выделения текста */
* {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Разрешаем выделение в поле ввода */
#search-input {
  -webkit-user-select: text;
  user-select: text;
}
/* ============= КОНЕЦ: ОБНОВЛЕННЫЕ МОБИЛЬНЫЕ СТИЛИ ============= */
</style>
</head>
<body>

  <div id="ui-layer" data-theme="dark">
    <div class="search-container" onclick="event.stopPropagation();">
  <input type="text" 
         id="search-input" 
         placeholder="Поиск объектов..." 
         autocomplete="off" 
         oninput="window.updateSearchSuggestions(this.value)"
         onkeydown="window.handleSearchEnter(event)"
         onclick="event.stopPropagation();">
  <div id="search-results" onclick="event.stopPropagation();"></div>
</div>
    
    <div class="controls">
    <button class="btn" onclick="handleButtonClick('theme')" 
            ontouchstart="handleTouchStart(this)" 
            ontouchend="handleTouchEnd(this)"
            title="Сменить тему">◑</button>
    <button class="btn" onclick="handleButtonClick('reset')" 
            ontouchstart="handleTouchStart(this)" 
            ontouchend="handleTouchEnd(this)"
            title="На спаун">⌂</button>
    <button class="btn" onclick="handleButtonClick('north')" 
            ontouchstart="handleTouchStart(this)" 
            ontouchend="handleTouchEnd(this)"
            title="На север">N</button>
</div>
  </div>
<script>
    // Функции для мобильных устройств
    function handleTouchStart(button) {
        button.style.transform = 'scale(0.95)';
        return false; // Предотвращаем дальнейшую обработку
    }
    
    function handleTouchEnd(button) {
        button.style.transform = '';
        return false; // Предотвращаем дальнейшую обработку
    }
    
    function handleButtonClick(action) {
        switch(action) {
            case 'theme':
                toggleMapTheme();
                break;
            case 'reset':
                resetView();
                break;
            case 'north':
                rotateNorth();
                break;
        }
        // Предотвращаем всплытие события
        event && event.stopPropagation();
        return false;
    }
</script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/p5.min.js"></script>
  <script src="addScreenPositionFunction.js"></script>
  <script src="global.js"></script>
  <script src="base_class.js"></script>
  <script src="class.js"></script>
  <script src="read_json.js"></script>
  <script src="draw.js"></script>
  
  <!-- Важно: ui-logic.js загружается ПОСЛЕ всех скриптов с данными -->
  <script src="ui-logic.js"></script>
  <script src="mobile-ui-fix.js"></script>
  <!-- Добавьте после других скриптов -->
<script src="admin-panel.js"></script>
  
  <script src="grdkmap.js"></script>

 <script>
    // Добавляем глобальные функции для кнопок
    window.toggleMapTheme = function() {
      if (typeof theme !== 'undefined') {
        theme = (theme === "light") ? "dark" : "light";
        document.getElementById('ui-layer').setAttribute('data-theme', theme);
        if (typeof applyTheme === 'function') {
          applyTheme();
        }
        if (typeof buildGlobalMesh === 'function') {
          buildGlobalMesh();
        }
      }
    };

    window.resetView = function() {
      if (typeof offsetX !== 'undefined') {
        offsetX = -8;
        offsetZ = 317;
        zoom = 4;
        if (typeof angleY !== 'undefined') angleY = 0;
        if (typeof angleX !== 'undefined') angleX = Math.PI / 2;
        
        // Останавливаем любую анимацию
        window.isAnimating = false;
        window.targetX = null;
        window.targetZ = null;
      }
    };

    window.rotateNorth = function() {
      if (typeof angleY !== 'undefined') {
        angleY = 0;
      }
    };
    
    // Обработчик Enter для поиска
    window.handleSearchEnter = function(event) {
        if (event.key === 'Enter') {
            const query = document.getElementById('search-input').value.trim();
            if (query.length < 2) return;
            
            // Вызываем функцию из ui-logic.js
            if (typeof window.handleSearchEnter === 'function') {
                window.handleSearchEnter(event);
            }
        }
    };
</script>
<!-- В конец body перед закрывающим тегом </body> -->
<script>
    // Инициализация для мобильных устройств
    document.addEventListener('DOMContentLoaded', function() {
        // Предотвращаем масштабирование страницы жестами
        document.addEventListener('touchmove', function(e) {
            if (e.scale !== 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Увеличиваем время отклика для мобильных
        if ('ontouchstart' in window) {
            FastClick.attach(document.body);
        }
    });
    
    // Загружаем FastClick для устранения задержки на мобильных
    var script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js';
    document.head.appendChild(script);
// Простой обработчик кнопок для ПК
document.addEventListener('DOMContentLoaded', function() {
  // Проверяем, не мобильное ли устройство
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if (!isMobile) {
    // Только для ПК оставляем обработчики onclick
    document.querySelectorAll('.btn[data-action]').forEach(btn => {
      const action = btn.getAttribute('data-action');
      btn.onclick = function(e) {
        e.stopPropagation();
        switch(action) {
          case 'theme': toggleMapTheme(); break;
          case 'reset': resetView(); break;
          case 'north': rotateNorth(); break;
        }
      };
    });
  }
  
  // Общий обработчик для предотвращения событий на кнопках
  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('mousedown', function(e) {
      e.stopPropagation();
    });
    btn.addEventListener('mouseup', function(e) {
      e.stopPropagation();
    });
  });
});
</script>
</body>
</html>
